
import React, { useState, useMemo } from 'react';
import { ToDoItem, ToDoStatus, UserProfile } from '../types';
import { Plus, Trash2, ArrowRight, ArrowLeft, CheckCircle2, Clock, Loader2, X, Send, CheckSquare, Calendar, AlertCircle, LayoutGrid, ListFilter, ChevronRight, Pin, LayoutList, GripVertical, MoreHorizontal, User, Printer } from 'lucide-react';
import { generateToDoPDF } from '../services/pdfService';

interface ToDoPageProps {
  todos: ToDoItem[];
  users: UserProfile[];
  currentUserEmail: string;
  onAdd: (item: Omit<ToDoItem, 'id' | 'createdAt' | 'status' | 'notes' | 'createdBy'>) => Promise<void>;
  onUpdateStatus: (id: string, status: ToDoStatus) => void;
  onDelete: (id: string) => void;
  onAddNote: (id: string, text: string) => Promise<void>;
}

const Avatar = ({ label, size = "md", className = "" }: { label: string, size?: "sm" | "md", className?: string }) => {
    const initials = label.includes('@') ? label.charAt(0).toUpperCase() : label.split(' ').map(n => n[0]).join('').toUpperCase();
    const sizeClasses = size === "sm" ? "w-6 h-6 text-[8px]" : "w-8 h-8 text-[10px]";
    return <div className={`${sizeClasses} rounded-full flex items-center justify-center font-black bg-gradient-to-br from-white to-slate-50 text-brand-700 border border-slate-200 shadow-sm ${className}`} title={label}>{initials}</div>;
};

const ToDoPage: React.FC<ToDoPageProps> = ({ todos, users, currentUserEmail, onAdd, onUpdateStatus, onDelete, onAddNote }) => {
  const [isAdding, setIsAdding] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isSendingNote, setIsSendingNote] = useState(false);
  const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);
  const [mobileActiveTab, setMobileActiveTab] = useState<ToDoStatus>('Bekliyor');
  const [viewMode, setViewMode] = useState<'board' | 'list'>('board');

  const [newTitle, setNewTitle] = useState('');
  const [newPriority, setNewPriority] = useState<'YÃ¼ksek' | 'Orta' | 'DÃ¼ÅŸÃ¼k'>('Orta');
  const [newComments, setNewComments] = useState('');
  const [newDueDate, setNewDueDate] = useState('');
  const [assignTo, setAssignTo] = useState('');
  const [selectedTask, setSelectedTask] = useState<ToDoItem | null>(null);
  const [newNote, setNewNote] = useState('');
  const [filterMode, setFilterMode] = useState<'all' | 'mine'>('all');
  const [priorityFilter, setPriorityFilter] = useState<'TÃ¼mÃ¼' | 'YÃ¼ksek' | 'Orta' | 'DÃ¼ÅŸÃ¼k'>('TÃ¼mÃ¼');
  const [taskToDelete, setTaskToDelete] = useState<string | null>(null);
  const [celebratingTaskId, setCelebratingTaskId] = useState<string | null>(null);

  const filteredTodos = useMemo(() => {
      let result = todos;
      if (filterMode === 'mine') { result = result.filter(t => t.assignedTo === currentUserEmail); }
      if (priorityFilter !== 'TÃ¼mÃ¼') { result = result.filter(t => t.priority === priorityFilter); }
      return result.sort((a, b) => { if (a.pinned && !b.pinned) return -1; if (!a.pinned && b.pinned) return 1; return b.createdAt - a.createdAt; });
  }, [todos, filterMode, priorityFilter, currentUserEmail]);

  const columns: { id: ToDoStatus; label: string; icon: any; color: string; bg: string; text: string; accent: string }[] = [ { id: 'Bekliyor', label: 'HAZIRLIK', icon: Clock, color: 'border-slate-300', bg: 'bg-slate-50', text: 'text-slate-600', accent: 'bg-slate-400' }, { id: 'Devam Ediyor', label: 'SÃœREÃ‡TE', icon: Loader2, color: 'border-blue-500', bg: 'bg-blue-50', text: 'text-blue-700', accent: 'bg-blue-600' }, { id: 'TamamlandÄ±', label: 'BÄ°TENLER', icon: CheckCircle2, color: 'border-emerald-500', bg: 'bg-emerald-50', text: 'text-emerald-700', accent: 'bg-emerald-500' }, ];

  const handleAdd = async (e: React.FormEvent) => { e.preventDefault(); if (!newTitle.trim()) return; setIsSubmitting(true); try { await onAdd({ title: newTitle, priority: newPriority, comments: newComments, assignedTo: assignTo || undefined, dueDate: newDueDate || undefined }); setNewTitle(''); setNewComments(''); setNewPriority('Orta'); setAssignTo(''); setNewDueDate(''); setIsAdding(false); } catch (error) { console.error(error); } finally { setIsSubmitting(false); } };
  const handleSendNote = async (e?: React.FormEvent) => { e?.preventDefault(); if (!selectedTask || !newNote.trim()) return; setIsSendingNote(true); try { await onAddNote(selectedTask.id, newNote); setNewNote(''); } catch (error) { console.error(error); } finally { setIsSendingNote(false); } };
  const handleStatusChange = (id: string, newStatus: ToDoStatus, e: React.MouseEvent) => { e.stopPropagation(); if (newStatus === 'TamamlandÄ±') { setCelebratingTaskId(id); setTimeout(() => { onUpdateStatus(id, newStatus); setCelebratingTaskId(null); }, 500); } else { onUpdateStatus(id, newStatus); } };
  
  const handlePrint = async () => {
      setIsGeneratingPdf(true);
      try { await generateToDoPDF(filteredTodos); } catch(e) { alert("PDF Ã¼retilemedi."); } finally { setIsGeneratingPdf(false); }
  };

  const PriorityBadge = ({ p }: { p: string }) => { const config = { 'YÃ¼ksek': { bg: 'bg-rose-50', text: 'text-rose-600', border: 'border-rose-200', icon: AlertCircle }, 'Orta': { bg: 'bg-amber-50', text: 'text-amber-600', border: 'border-amber-200', icon: Clock }, 'DÃ¼ÅŸÃ¼k': { bg: 'bg-emerald-50', text: 'text-emerald-600', border: 'border-emerald-200', icon: CheckCircle2 } }; /* @ts-ignore */ const c = config[p] || config['Orta']; return ( <span className={`text-[9px] font-black px-2 py-0.5 rounded-md border uppercase tracking-wider flex items-center gap-1 ${c.bg} ${c.text} ${c.border}`}> {p} </span> ); };

  return (
    <div className="flex flex-col h-full animate-in max-w-[1920px] mx-auto overflow-hidden relative">
      <div className="bg-white px-4 md:px-8 py-5 border-b border-slate-100 flex flex-col xl:flex-row justify-between xl:items-center gap-6 shrink-0 z-20">
        <div><div className="flex items-center gap-3"><div className="p-2.5 bg-gradient-to-br from-brand-800 to-brand-950 text-white rounded-xl shadow-lg shadow-brand-200"><CheckSquare className="w-5 h-5" /></div><div><h2 className="text-lg font-black text-slate-900 tracking-tight uppercase leading-none">GÃ¶rev Merkezi</h2><p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Ä°ÅŸ AkÄ±ÅŸÄ± & Takip</p></div></div></div>
        <div className="flex flex-col md:flex-row gap-3 items-start md:items-center overflow-x-auto no-scrollbar pb-2 md:pb-0">
             <div className="flex bg-slate-100 p-1 rounded-xl border border-slate-200 shrink-0"><button onClick={() => setViewMode('board')} className={`p-2 rounded-lg transition-all ${viewMode === 'board' ? 'bg-white text-brand-700 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}><LayoutGrid className="w-4 h-4" /></button><button onClick={() => setViewMode('list')} className={`p-2 rounded-lg transition-all ${viewMode === 'list' ? 'bg-white text-brand-700 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}><LayoutList className="w-4 h-4" /></button></div>
             <button onClick={handlePrint} disabled={isGeneratingPdf} className="px-3 py-1.5 bg-white border border-slate-200 text-slate-600 rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-slate-50 transition-all shadow-sm disabled:opacity-50"><Printer className="w-4 h-4" /></button>
             <div className="flex items-center gap-2 bg-slate-50 p-1 rounded-xl border border-slate-100 shrink-0">{(['TÃ¼mÃ¼', 'YÃ¼ksek', 'Orta', 'DÃ¼ÅŸÃ¼k'] as const).map(p => (<button key={p} onClick={() => setPriorityFilter(p)} className={`px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-wider transition-all ${priorityFilter === p ? 'bg-white text-slate-900 shadow-sm ring-1 ring-slate-200' : 'text-slate-400 hover:text-slate-600'}`}>{p}</button>))}</div>
             <div className="h-6 w-px bg-slate-200 hidden md:block"></div>
             <div className="flex bg-slate-100 p-1 rounded-xl border border-slate-200 shrink-0"><button onClick={() => setFilterMode('all')} className={`px-4 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all ${filterMode === 'all' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Ekip</button><button onClick={() => setFilterMode('mine')} className={`px-4 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all ${filterMode === 'mine' ? 'bg-white text-brand-700 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Bana Ã–zel</button></div>
            <button onClick={() => setIsAdding(true)} className="hidden md:flex px-6 py-2.5 bg-brand-950 text-white font-black rounded-xl hover:bg-brand-800 shadow-xl shadow-brand-100 transition-all items-center justify-center gap-2 text-[10px] uppercase tracking-widest active:scale-95 shrink-0"><Plus className="w-4 h-4" /> Yeni GÃ¶rev</button>
        </div>
      </div>

      {viewMode === 'board' && (<div className="lg:hidden px-4 pt-2 bg-white border-b border-slate-100 shrink-0 sticky top-0 z-10"><div className="flex gap-4 overflow-x-auto no-scrollbar pb-0">{columns.map(col => (<button key={col.id} onClick={() => setMobileActiveTab(col.id)} className={`flex items-center gap-2 pb-3 border-b-2 transition-all whitespace-nowrap px-1 ${mobileActiveTab === col.id ? 'border-brand-600 text-brand-700' : 'border-transparent text-slate-400'}`}><col.icon className={`w-4 h-4 ${mobileActiveTab === col.id && col.id === 'Devam Ediyor' ? 'animate-spin' : ''}`} /><span className="text-[10px] font-black uppercase tracking-wider">{col.label}</span><span className="bg-slate-100 text-slate-500 text-[9px] px-1.5 rounded-md font-bold">{filteredTodos.filter(t => t.status === col.id).length}</span></button>))}</div></div>)}

      <div className="flex-1 overflow-hidden relative bg-slate-50">
          {viewMode === 'board' && (<div className="h-full w-full flex lg:flex-row flex-col p-4 md:p-6 gap-6 overflow-x-auto lg:overflow-hidden custom-scroll">{columns.map(col => { const items = filteredTodos.filter(t => t.status === col.id); const isVisible = mobileActiveTab === col.id; return (<div key={col.id} className={`flex-1 min-w-[320px] max-w-[450px] flex flex-col h-full ${!isVisible ? 'hidden lg:flex' : 'flex'}`}><div className="flex items-center justify-between mb-4 px-2"><h3 className="font-black text-[11px] text-slate-500 uppercase tracking-[0.2em] flex items-center gap-2"><div className={`w-2 h-2 rounded-full ${col.accent}`}></div> {col.label}</h3></div><div className="flex-1 overflow-y-auto custom-scroll space-y-3 pb-24 lg:pb-4 px-1">{items.length === 0 ? (<div className="h-32 border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center opacity-40"><p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">KayÄ±t Yok</p></div>) : (items.map(item => { const isOverdue = item.dueDate && new Date(item.dueDate) < new Date() && item.status !== 'TamamlandÄ±'; const isCelebrating = celebratingTaskId === item.id; return (<div key={item.id} onClick={() => setSelectedTask(item)} className={`bg-white p-5 rounded-2xl border border-slate-200/60 shadow-sm hover:shadow-lg hover:border-brand-300 transition-all cursor-pointer group relative overflow-hidden active:scale-[0.98] ${item.pinned ? 'ring-1 ring-brand-500 ring-offset-1' : ''} ${isCelebrating ? 'scale-105 border-emerald-400 ring-4 ring-emerald-100 z-50' : ''}`}>{isCelebrating && (<div className="absolute inset-0 z-20 flex items-center justify-center bg-white/80 backdrop-blur-[2px] animate-in fade-in duration-300"><div className="bg-emerald-500 text-white p-4 rounded-full shadow-2xl animate-bounce"><CheckCircle2 className="w-8 h-8" /></div></div>)}{item.pinned && <div className="absolute top-0 right-0 p-1.5 bg-brand-500 text-white rounded-bl-xl"><Pin className="w-3 h-3 fill-current" /></div>}<div className="flex justify-between items-start mb-3 pr-6"><PriorityBadge p={item.priority} />{isOverdue && <span className="text-[9px] font-black text-rose-600 bg-rose-50 px-2 py-0.5 rounded-md border border-rose-100 flex items-center gap-1"><AlertCircle className="w-3 h-3" /> GECÄ°KTÄ°</span>}</div><h4 className="font-bold text-sm text-slate-800 leading-snug mb-3 line-clamp-2">{item.title}</h4><div className="flex items-center justify-between pt-3 border-t border-slate-50 mt-auto"><div className="flex items-center gap-2">{item.assignedTo ? <Avatar label={item.assignedTo} size="sm" /> : <div className="w-6 h-6 rounded-full bg-slate-50 border border-dashed border-slate-200 flex items-center justify-center text-slate-300"><User className="w-3 h-3" /></div>}{item.dueDate && (<div className="text-[9px] font-bold text-slate-400 flex items-center gap-1 uppercase tracking-wider"><Calendar className="w-3 h-3 text-slate-300" /> {new Date(item.dueDate).toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' })}</div>)}</div><div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">{col.id !== 'Bekliyor' && (<button onClick={(e) => handleStatusChange(item.id, col.id === 'TamamlandÄ±' ? 'Devam Ediyor' : 'Bekliyor', e)} className="p-1.5 bg-slate-100 hover:bg-white border border-slate-200 rounded-lg text-slate-400 hover:text-brand-600"><ArrowLeft className="w-3.5 h-3.5" /></button>)}{col.id !== 'TamamlandÄ±' && (<button onClick={(e) => handleStatusChange(item.id, col.id === 'Bekliyor' ? 'Devam Ediyor' : 'TamamlandÄ±', e)} className="p-1.5 bg-brand-50 border border-brand-100 rounded-lg text-brand-600 hover:bg-brand-600 hover:text-white"><ArrowRight className="w-3.5 h-3.5" /></button>)}</div></div></div>); }))}</div></div>); })}</div>)}
          {viewMode === 'list' && (<div className="p-4 md:p-8 h-full overflow-y-auto custom-scroll"><div className="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden"><div className="hidden md:grid grid-cols-12 gap-4 px-6 py-4 border-b border-slate-100 bg-slate-50/50 text-[10px] font-black text-slate-400 uppercase tracking-widest"><div className="col-span-5">GÃ¶rev TanÄ±mÄ±</div><div className="col-span-2">Durum</div><div className="col-span-2">Ã–ncelik</div><div className="col-span-2">Sorumlu & Termin</div><div className="col-span-1 text-right">Ä°ÅŸlem</div></div><div className="divide-y divide-slate-50">{filteredTodos.map(item => { const col = columns.find(c => c.id === item.status) || columns[0]; const isOverdue = item.dueDate && new Date(item.dueDate) < new Date() && item.status !== 'TamamlandÄ±'; return (<div key={item.id} onClick={() => setSelectedTask(item)} className="grid grid-cols-1 md:grid-cols-12 gap-4 px-6 py-5 items-center hover:bg-slate-50 cursor-pointer group transition-all"><div className="col-span-12 md:col-span-5"><div className="flex items-start gap-3">{item.pinned && <Pin className="w-4 h-4 text-brand-500 fill-current mt-1 shrink-0" />}<div><h4 className={`text-sm font-bold text-slate-800 ${item.status === 'TamamlandÄ±' ? 'line-through text-slate-400' : ''}`}>{item.title}</h4>{item.comments && <p className="text-xs text-slate-500 mt-1 line-clamp-1">{item.comments}</p>}</div></div></div><div className="col-span-6 md:col-span-2"><span className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg text-[10px] font-black uppercase tracking-wider border ${col.bg} ${col.text} ${col.color}`}><col.icon className="w-3 h-3" /> {item.status}</span></div><div className="col-span-6 md:col-span-2"><PriorityBadge p={item.priority} /></div><div className="col-span-12 md:col-span-2 flex items-center gap-3">{item.assignedTo ? <Avatar label={item.assignedTo} size="sm" /> : <div className="w-6 h-6 rounded-full bg-slate-100 border border-slate-200" />}<div className="flex flex-col"><span className="text-[10px] font-bold text-slate-700">{item.assignedTo?.split('@')[0] || '-'}</span>{item.dueDate && <span className={`text-[9px] font-bold ${isOverdue ? 'text-rose-500' : 'text-slate-400'}`}>{new Date(item.dueDate).toLocaleDateString('tr-TR')}</span>}</div></div><div className="col-span-12 md:col-span-1 flex justify-end"><button className="p-2 text-slate-300 hover:text-brand-600 hover:bg-brand-50 rounded-lg transition-all"><ChevronRight className="w-5 h-5" /></button></div></div>) })}</div></div></div>)}
      </div>

      <button onClick={() => setIsAdding(true)} className="md:hidden fixed bottom-6 right-6 w-14 h-14 bg-brand-950 text-white rounded-2xl flex items-center justify-center shadow-2xl shadow-brand-900/50 z-[100] active:scale-90 transition-all border border-white/10"><Plus className="w-6 h-6" /></button>

      {isAdding && (<div className="fixed inset-0 z-[500] bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-0 lg:p-4 animate-in fade-in"><div className="bg-white w-full max-w-xl h-full lg:h-auto lg:rounded-[2.5rem] shadow-2xl flex flex-col overflow-hidden border border-white/20"><div className="px-8 py-6 border-b border-slate-100 bg-white flex justify-between items-center shrink-0"><div className="flex items-center gap-3"><div className="p-2.5 bg-brand-600 text-white rounded-xl shadow-lg shadow-brand-100"><Plus className="w-5 h-5" /></div><h3 className="text-lg font-black text-slate-900 tracking-tight uppercase">Yeni KayÄ±t</h3></div><button onClick={() => setIsAdding(false)} className="p-2 bg-slate-100 rounded-full text-slate-400 hover:text-slate-600 transition-colors"><X className="w-5 h-5" /></button></div><form onSubmit={handleAdd} className="p-6 lg:p-8 space-y-6 flex-1 overflow-y-auto custom-scroll"><div className="space-y-2"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">GÃ–REV BAÅžLIÄžI</label><input type="text" placeholder="YapÄ±lacak iÅŸ nedir?" value={newTitle} onChange={(e) => setNewTitle(e.target.value)} className="w-full p-4 bg-slate-50 border-2 border-transparent focus:bg-white focus:border-brand-500 rounded-2xl text-sm font-bold outline-none transition-all placeholder:text-slate-300" autoFocus /></div><div className="grid grid-cols-1 sm:grid-cols-2 gap-4"><div className="space-y-2"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">SORUMLU</label><div className="relative"><select value={assignTo} onChange={(e) => setAssignTo(e.target.value)} className="w-full p-4 bg-slate-50 border-2 border-transparent focus:bg-white focus:border-brand-500 rounded-2xl text-sm font-bold outline-none appearance-none"><option value="">SeÃ§ilmemiÅŸ</option>{users.map(u => <option key={u.uid} value={u.email}>{u.displayName || u.email}</option>)}</select><ChevronRight className="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 rotate-90 pointer-events-none" /></div></div><div className="space-y-2"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Ã–NCELÄ°K</label><div className="relative"><select value={newPriority} onChange={(e) => setNewPriority(e.target.value as any)} className="w-full p-4 bg-slate-50 border-2 border-transparent focus:bg-white focus:border-brand-500 rounded-2xl text-sm font-bold outline-none appearance-none"><option value="YÃ¼ksek">ðŸ”¥ YÃœKSEK</option><option value="Orta">âš¡ ORTA</option><option value="DÃ¼ÅŸÃ¼k">ðŸŒ± DÃœÅžÃœK</option></select><ChevronRight className="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 rotate-90 pointer-events-none" /></div></div></div><div className="space-y-2"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">TERMÄ°N TARÄ°HÄ°</label><input type="date" value={newDueDate} onChange={(e) => setNewDueDate(e.target.value)} className="w-full p-4 bg-slate-50 border-2 border-transparent focus:bg-white focus:border-brand-500 rounded-2xl text-sm font-bold outline-none text-slate-700" /></div><div className="space-y-2"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">NOTLAR / DETAYLAR</label><textarea value={newComments} onChange={(e) => setNewComments(e.target.value)} placeholder="Ek bilgiler..." className="w-full p-4 bg-slate-50 border-2 border-transparent focus:bg-white focus:border-brand-500 rounded-2xl text-sm font-bold h-32 resize-none outline-none transition-all placeholder:text-slate-300" /></div><div className="flex gap-4 pt-4 pb-12 lg:pb-0 border-t border-slate-50 mt-auto"><button type="button" onClick={() => setIsAdding(false)} className="flex-1 py-4 border-2 border-slate-100 rounded-2xl font-black text-xs text-slate-500 hover:bg-slate-50 uppercase tracking-widest transition-colors">VazgeÃ§</button><button type="submit" disabled={isSubmitting || !newTitle.trim()} className="flex-[2] py-4 bg-brand-950 text-white rounded-2xl font-black text-xs hover:bg-brand-900 shadow-xl shadow-brand-200 flex items-center justify-center gap-2 uppercase tracking-widest disabled:opacity-30 transition-all">{isSubmitting ? <Loader2 className="w-4 h-4 animate-spin" /> : 'KAYDI TAMAMLA'}</button></div></form></div></div>)}
      {selectedTask && (<div className="fixed inset-0 z-[500] bg-slate-900/40 backdrop-blur-xl flex items-center justify-center p-0 lg:p-6 animate-in slide-in-from-bottom-4 duration-300"><div className="bg-white w-full max-w-4xl h-full lg:h-auto lg:max-h-[90vh] flex flex-col shadow-2xl lg:rounded-[3rem] overflow-hidden border border-white/20"><div className="px-6 md:px-10 py-6 md:py-8 border-b border-slate-100 flex justify-between items-start bg-white shrink-0 relative"><div className="flex items-center gap-5"><div className="w-12 h-12 md:w-16 md:h-16 bg-slate-50 text-brand-600 rounded-2xl flex items-center justify-center border border-slate-100 shadow-inner shrink-0"><CheckSquare className="w-6 h-6 md:w-8 md:h-8" /></div><div><div className="flex flex-wrap gap-2 mb-2"><PriorityBadge p={selectedTask.priority} /><span className="text-[9px] font-black px-2 py-0.5 rounded-md bg-slate-100 text-slate-500 border border-slate-200 uppercase tracking-wider">{selectedTask.status}</span></div><h3 className="text-lg md:text-2xl font-black text-slate-900 leading-tight pr-8">{selectedTask.title}</h3></div></div><div className="flex items-center gap-2"><button onClick={() => setSelectedTask(null)} className="p-3 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded-full text-slate-400 hover:text-slate-600 transition-colors shadow-sm"><X className="w-6 h-6" /></button></div></div><div className="flex-1 flex flex-col min-h-0 bg-slate-50/50"><div className="flex-1 px-6 md:px-10 py-8 overflow-y-auto custom-scroll space-y-8"><div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div className="p-6 bg-white rounded-3xl border border-slate-200 shadow-sm flex items-center gap-4">{selectedTask.assignedTo ? <Avatar label={selectedTask.assignedTo} /> : <div className="w-10 h-10 rounded-full bg-slate-50 border border-dashed border-slate-200" />}<div><span className="text-[9px] font-black text-slate-400 uppercase tracking-widest block mb-0.5">SORUMLU PERSONEL</span><div className="font-black text-slate-800 text-sm">{selectedTask.assignedTo || 'AtanmamÄ±ÅŸ'}</div></div></div><div className="p-6 bg-white rounded-3xl border border-slate-200 shadow-sm flex items-center gap-4"><div className="w-10 h-10 rounded-2xl bg-brand-50 flex items-center justify-center text-brand-600"><Calendar className="w-5 h-5" /></div><div><span className="text-[9px] font-black text-slate-400 uppercase tracking-widest block mb-0.5">TERMÄ°N SÃœRESÄ°</span><div className="font-black text-slate-800 text-sm uppercase tracking-wider">{selectedTask.dueDate ? new Date(selectedTask.dueDate).toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' }) : 'BelirtilmemiÅŸ'}</div></div></div></div><div className="bg-white p-8 rounded-[2.5rem] border border-slate-200 shadow-sm relative overflow-hidden"><h4 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">Ä°Åž TANIMI</h4><p className="text-sm font-bold text-slate-700 leading-relaxed whitespace-pre-wrap">{selectedTask.comments || 'Herhangi bir aÃ§Ä±klama girilmemiÅŸ.'}</p></div><div className="space-y-4"><h4 className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] pl-2">SÃ¼reÃ§ NotlarÄ± ({selectedTask.notes?.length || 0})</h4><div className="space-y-4">{selectedTask.notes?.map(n => (<div key={n.id} className="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm animate-in flex gap-4"><div className="shrink-0 pt-1"><Avatar label={n.author} size="sm" /></div><div className="flex-1 min-w-0"><div className="flex justify-between items-center mb-1"><span className="text-[11px] font-black text-brand-700 uppercase tracking-wider">{n.author.split('@')[0]}</span><span className="text-[10px] text-slate-400 font-bold">{new Date(n.date).toLocaleString('tr-TR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })}</span></div><p className="text-sm text-slate-700 font-medium leading-relaxed">{n.text}</p></div></div>))}</div></div></div><div className="p-6 md:p-8 bg-white border-t border-slate-200 shrink-0 shadow-inner safe-area-bottom"><form onSubmit={handleSendNote} className="flex gap-3 mb-6"><input type="text" value={newNote} onChange={(e) => setNewNote(e.target.value)} placeholder="GeliÅŸmeleri paylaÅŸÄ±n..." className="flex-1 p-4 bg-slate-50 border-none rounded-2xl text-sm font-bold focus:ring-2 focus:ring-brand-500/10 outline-none transition-all placeholder:text-slate-400" /><button type="submit" disabled={isSendingNote || !newNote.trim()} className="w-14 h-14 bg-brand-950 text-white rounded-2xl flex items-center justify-center hover:bg-brand-600 transition-all shadow-xl disabled:opacity-20">{isSendingNote ? <Loader2 className="w-6 h-6 animate-spin" /> : <Send className="w-5 h-5" />}</button></form><div className="flex gap-4"><button type="button" onClick={() => setTaskToDelete(selectedTask.id)} className="px-6 py-4 border-2 border-rose-100 text-rose-600 rounded-2xl font-black text-xs hover:bg-rose-50 transition-all uppercase tracking-widest flex items-center gap-2"><Trash2 className="w-4 h-4" /> Sil</button><button onClick={() => setSelectedTask(null)} className="flex-1 py-4 bg-brand-950 text-white rounded-2xl font-black text-xs uppercase tracking-[0.2em] shadow-xl hover:opacity-90">KAPAT</button></div></div></div></div></div>)}
      {taskToDelete && (<div className="fixed inset-0 z-[600] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in"><div className="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl overflow-hidden border border-slate-200"><div className="p-8 text-center"><div className="w-16 h-16 bg-rose-50 rounded-2xl flex items-center justify-center mx-auto mb-6 border border-rose-100"><Trash2 className="w-8 h-8 text-rose-600" /></div><h3 className="text-xl font-black text-slate-900 mb-2 tracking-tight">KaydÄ± Sil?</h3><p className="text-sm text-slate-500 leading-relaxed mb-8 font-medium">Bu iÅŸlem geri alÄ±namaz. GÃ¶rev kalÄ±cÄ± olarak sistemden silinecektir.</p><div className="flex gap-3"><button onClick={() => setTaskToDelete(null)} className="flex-1 py-4 bg-white border border-slate-200 rounded-2xl text-slate-700 font-black text-xs uppercase tracking-widest hover:bg-slate-50 transition-all">Ä°ptal</button><button onClick={() => { if(taskToDelete) { onDelete(taskToDelete); setTaskToDelete(null); setSelectedTask(null); } }} className="flex-1 py-4 bg-rose-600 text-white rounded-2xl font-black text-xs uppercase tracking-widest hover:bg-rose-700 shadow-xl shadow-rose-200 transition-all">SÄ°L</button></div></div></div></div>)}
    </div>
  );
};

export default ToDoPage;
